# .github/workflows/terraform-deploy.yml
name: Deploy Infrastructure

on:
  workflow_dispatch:
    inputs:
      resource_type:
        description: 'Type of resource to deploy'
        required: true
        type: choice
        options:
          - ec2_instance
          - s3_bucket
          - rds_instance
          - ecs_service
          - alb
          - security_group
      
      name:
        description: 'Resource name'
        required: true
        type: string
      
      environment:
        description: 'Deployment environment'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
      
      region:
        description: 'AWS region'
        required: true
        default: 'eu-west-2'
        type: choice
        options:
          - eu-west-2
          - us-east-1
          - us-west-2
          - eu-west-1
      
      # EC2 specific inputs
      instance_type:
        description: 'EC2 instance type (for EC2 only)'
        required: false
        default: 't2.micro'
        type: string
      
      volume_size:
        description: 'Root volume size in GB (for EC2 only)'
        required: false
        default: '20'
        type: string
      
      assign_eip:
        description: 'Assign Elastic IP to EC2 instance'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      
      # VPC related inputs
      vpc_id:
        description: 'VPC ID for the resource'
        required: false
        default: 'vpc-01234567890abcdef'
        type: string
        
      subnet_id:
        description: 'Subnet for EC2 or primary subnet for other resources'
        required: false
        default: 'subnet-07759e500cfdfb6b2'
        type: choice
        options:
          - 'subnet-07759e500cfdfb6b2' # eu-west-2a
          - 'subnet-0d95a35be6e1fb603' # eu-west-2b
          - 'subnet-00e88d7e1a6b7c689' # eu-west-2c
      
      # S3 specific inputs
      bucket_name:
        description: 'S3 bucket name (for S3 only)'
        required: false
        type: string
      
      versioning_enabled:
        description: 'Enable versioning for S3 bucket'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
      
      # RDS specific inputs
      engine:
        description: 'Database engine (for RDS only)'
        required: false
        default: 'mysql'
        type: choice
        options:
          - 'mysql'
          - 'postgres'
          - 'aurora-mysql'
          - 'aurora-postgresql'
      
      engine_version:
        description: 'Database engine version (for RDS only)'
        required: false
        default: '8.0'
        type: string
      
      instance_class:
        description: 'RDS instance class (for RDS only)'
        required: false
        default: 'db.t3.micro'
        type: string
      
      allocated_storage:
        description: 'Database storage size in GB (for RDS only)'
        required: false
        default: '20'
        type: string
      
      master_username:
        description: 'Database master username (for RDS only)'
        required: false
        default: 'admin'
        type: string
        
      multi_az:
        description: 'Enable Multi-AZ deployment for RDS'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
      
      # ECS specific inputs
      container_image:
        description: 'Container image (for ECS only, e.g. nginx:latest)'
        required: false
        default: 'nginx:latest'
        type: string
      
      container_port:
        description: 'Container port (for ECS only)'
        required: false
        default: '80'
        type: string
      
      cpu:
        description: 'CPU units for ECS task (256=0.25vCPU)'
        required: false
        default: '256'
        type: string
      
      memory:
        description: 'Memory for ECS task in MB'
        required: false
        default: '512'
        type: string
      
      launch_type:
        description: 'ECS launch type'
        required: false
        default: 'FARGATE'
        type: choice
        options:
          - 'FARGATE'
          - 'EC2'
      
      # ALB specific inputs
      internal:
        description: 'Whether the ALB should be internal'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
      
      # Security Group specific inputs
      sg_description:
        description: 'Security group description'
        required: false
        default: 'Managed by Terraform'
        type: string
      
      ingress_rules:
        description: 'Ingress rules in JSON format (for Security Group only)'
        required: false
        default: '[{"from_port":80,"to_port":80,"protocol":"tcp","cidr_blocks":["0.0.0.0/0"],"description":"HTTP"}]'
        type: string

env:
    APP_WEBHOOK_URL: https://platform-hub.onrender.com/api/webhook/deployment
    SECURITY_GROUP_ID: "sg-060323606252babd1"

jobs:
  terraform:
    name: 'Terraform Deploy'
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    
    defaults:
      run:
        shell: bash
    
    steps:
    - name: Checkout
      uses: actions/checkout@v3
    
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: 1.5.0
    
    # Configure AWS credentials with role assumption
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        role-to-assume: arn:aws:iam::436549840164:role/github_action_role
        aws-region: ${{ github.event.inputs.region }}
    
    - name: Generate Deployment ID
      id: deployment_id
      run: echo "id=deploy-$(date +%s)" >> $GITHUB_OUTPUT
    
    - name: Generate Terraform Configuration
      run: |
        mkdir -p terraform-config
        
        # Create variables.tf to declare all variables
        cat > terraform-config/variables.tf << EOF
        variable "deployment_id" {
          description = "Unique identifier for this deployment"
          type        = string
        }
        
        # Common variables
        variable "region" {
          description = "AWS region for the resources"
          type        = string
          default     = "${{ github.event.inputs.region }}"
        }
        
        variable "environment" {
          description = "Deployment environment (dev, staging, prod)"
          type        = string
          default     = "${{ github.event.inputs.environment }}"
        }
        
        variable "name" {
          description = "Resource name"
          type        = string
          default     = "${{ github.event.inputs.name }}"
        }
        
        # Networking variables
        variable "vpc_id" {
          description = "VPC ID for the resource"
          type        = string
          default     = "${{ github.event.inputs.vpc_id }}"
        }
        
        variable "subnet_id" {
          description = "Primary subnet ID"
          type        = string
          default     = "${{ github.event.inputs.subnet_id }}"
        }
        
        # EC2 specific variables
        variable "instance_type" {
          description = "EC2 instance type"
          type        = string
          default     = "${{ github.event.inputs.instance_type }}"
        }
        
        variable "root_volume_size" {
          description = "Size in GB for the root volume"
          type        = number
          default     = ${{ github.event.inputs.volume_size }}
        }
        
        variable "assign_eip" {
          description = "Whether to assign Elastic IP to the instance"
          type        = bool
          default     = ${{ github.event.inputs.assign_eip }}
        }
        
        variable "security_group_ids" {
          description = "List of security group IDs"
          type        = list(string)
          default     = ["${{ env.SECURITY_GROUP_ID }}"]
        }
        
        # S3 specific variables
        variable "bucket_name" {
          description = "Name of the S3 bucket"
          type        = string
          default     = "${{ github.event.inputs.bucket_name }}"
        }
        
        variable "versioning_enabled" {
          description = "Whether to enable bucket versioning"
          type        = bool
          default     = ${{ github.event.inputs.versioning_enabled || 'false' }}
        }
        
        # RDS specific variables
        variable "engine" {
          description = "Database engine"
          type        = string
          default     = "${{ github.event.inputs.engine }}"
        }
        
        variable "engine_version" {
          description = "Database engine version"
          type        = string
          default     = "${{ github.event.inputs.engine_version }}"
        }
        
        variable "instance_class" {
          description = "DB instance class"
          type        = string
          default     = "${{ github.event.inputs.instance_class }}"
        }
        
        variable "allocated_storage" {
          description = "Allocated storage in GB"
          type        = number
          default     = ${{ github.event.inputs.allocated_storage || 20 }}
        }
        
        variable "master_username" {
          description = "Database master username"
          type        = string
          default     = "${{ github.event.inputs.master_username }}"
        }
        
        variable "master_password" {
          description = "Database master password"
          type        = string
          default     = ""
          sensitive   = true
        }
        
        variable "multi_az" {
          description = "Enable Multi-AZ deployment"
          type        = bool
          default     = ${{ github.event.inputs.multi_az || 'false' }}
        }
        
        # ECS specific variables
        variable "container_image" {
          description = "Container image"
          type        = string
          default     = "${{ github.event.inputs.container_image }}"
        }
        
        variable "container_port" {
          description = "Container port"
          type        = number
          default     = ${{ github.event.inputs.container_port || 80 }}
        }
        
        variable "cpu" {
          description = "CPU units for ECS task"
          type        = number
          default     = ${{ github.event.inputs.cpu || 256 }}
        }
        
        variable "memory" {
          description = "Memory for ECS task in MB"
          type        = number
          default     = ${{ github.event.inputs.memory || 512 }}
        }
        
        variable "launch_type" {
          description = "ECS launch type"
          type        = string
          default     = "${{ github.event.inputs.launch_type }}"
        }
        
        # ALB specific variables
        variable "internal" {
          description = "Whether the ALB should be internal"
          type        = bool
          default     = ${{ github.event.inputs.internal || 'false' }}
        }
        
        # Security Group specific variables
        variable "sg_description" {
          description = "Security group description"
          type        = string
          default     = "${{ github.event.inputs.sg_description }}"
        }
        
        variable "ingress_rules" {
          description = "Ingress rules for security group"
          type        = string
          default     = <<-EOT
        ${{ github.event.inputs.ingress_rules }}
        EOT
        }
        EOF
        
        # Create resource-specific main.tf
        if [[ "${{ github.event.inputs.resource_type }}" == "ec2_instance" ]]; then
          cat > terraform-config/main.tf << EOF
        provider "aws" {
          region = var.region
        }
        
        module "ec2_instance" {
          source = "../terraform/modules/ec2_instance"
          
          name                = var.name
          environment         = var.environment
          region              = var.region
          instance_type       = var.instance_type
          subnet_id           = var.subnet_id
          security_group_ids  = var.security_group_ids
          root_volume_size    = var.root_volume_size
          assign_eip          = var.assign_eip
          deployment_id       = var.deployment_id
        }
        EOF
          
          # Create outputs.tf for EC2
          cat > terraform-config/outputs.tf << EOF
        output "instance_id" {
          value = module.ec2_instance.instance_id
          description = "The ID of the created EC2 instance"
        }
        
        output "public_ip" {
          value = module.ec2_instance.elastic_ip != null ? module.ec2_instance.elastic_ip : module.ec2_instance.instance_public_ip
          description = "The public IP address of the instance"
        }
        
        output "ssh_command" {
          value = module.ec2_instance.ssh_command
          description = "SSH command to connect to the instance"
        }
        EOF
          
        elif [[ "${{ github.event.inputs.resource_type }}" == "s3_bucket" ]]; then
          cat > terraform-config/main.tf << EOF
        provider "aws" {
          region = var.region
        }
        
        module "s3_bucket" {
          source = "../terraform/modules/s3_bucket"
          
          bucket_name        = var.bucket_name
          environment        = var.environment
          region             = var.region
          versioning_enabled = var.versioning_enabled
          deployment_id      = var.deployment_id
        }
        EOF
          
          # Create outputs.tf for S3
          cat > terraform-config/outputs.tf << EOF
        output "bucket_id" {
          value = module.s3_bucket.bucket_id
          description = "The name of the bucket"
        }
        
        output "bucket_arn" {
          value = module.s3_bucket.bucket_arn
          description = "The ARN of the bucket"
        }
        
        output "bucket_domain_name" {
          value = module.s3_bucket.bucket_domain_name
          description = "The domain name of the bucket"
        }
        EOF
        
        elif [[ "${{ github.event.inputs.resource_type }}" == "rds_instance" ]]; then
          cat > terraform-config/main.tf << EOF
        provider "aws" {
          region = var.region
        }
        
        module "rds_instance" {
          source = "../terraform/modules/rds_instance"
          
          name              = var.name
          environment       = var.environment
          region            = var.region
          vpc_id            = var.vpc_id
          subnet_ids        = [var.subnet_id]
          engine            = var.engine
          engine_version    = var.engine_version
          instance_class    = var.instance_class
          allocated_storage = var.allocated_storage
          master_username   = var.master_username
          master_password   = var.master_password
          multi_az          = var.multi_az
          deployment_id     = var.deployment_id
        }
        EOF
          
          # Create outputs.tf for RDS
          cat > terraform-config/outputs.tf << EOF
        output "db_instance_id" {
          value = module.rds_instance.db_instance_id
          description = "The ID of the RDS instance"
        }
        
        output "db_instance_address" {
          value = module.rds_instance.db_instance_address
          description = "The address of the RDS instance"
        }
        
        output "db_instance_endpoint" {
          value = module.rds_instance.db_instance_endpoint
          description = "The endpoint of the RDS instance"
        }
        
        output "db_security_group_id" {
          value = module.rds_instance.db_security_group_id
          description = "The security group ID for the RDS instance"
        }
        
        output "ssm_parameter_path" {
          value = module.rds_instance.ssm_parameter_path
          description = "Path to stored database credentials in SSM"
        }
        EOF
        
        elif [[ "${{ github.event.inputs.resource_type }}" == "ecs_service" ]]; then
          cat > terraform-config/main.tf << EOF
        provider "aws" {
          region = var.region
        }
        
        module "ecs_service" {
          source = "../terraform/modules/ecs_service"
          
          name            = var.name
          environment     = var.environment
          region          = var.region
          vpc_id          = var.vpc_id
          subnet_ids      = [var.subnet_id]
          container_image = var.container_image
          container_port  = var.container_port
          cpu             = var.cpu
          memory          = var.memory
          launch_type     = var.launch_type
          deployment_id   = var.deployment_id
        }
        EOF
          
          # Create outputs.tf for ECS
          cat > terraform-config/outputs.tf << EOF
        output "cluster_id" {
          value = module.ecs_service.cluster_id
          description = "The ID of the ECS cluster"
        }
        
        output "service_id" {
          value = module.ecs_service.service_id
          description = "The ID of the ECS service"
        }
        
        output "task_definition_arn" {
          value = module.ecs_service.task_definition_arn
          description = "The ARN of the task definition"
        }
        
        output "log_group_name" {
          value = module.ecs_service.log_group_name
          description = "The CloudWatch log group name"
        }
        EOF
        
        elif [[ "${{ github.event.inputs.resource_type }}" == "alb" ]]; then
          cat > terraform-config/main.tf << EOF
        provider "aws" {
          region = var.region
        }
        
        module "alb" {
          source = "../terraform/modules/alb"
          
          name          = var.name
          environment   = var.environment
          region        = var.region
          vpc_id        = var.vpc_id
          subnet_ids    = [var.subnet_id]
          internal      = var.internal
          deployment_id = var.deployment_id
        }
        EOF
          
          # Create outputs.tf for ALB
          cat > terraform-config/outputs.tf << EOF
        output "alb_id" {
          value = module.alb.alb_id
          description = "The ID of the ALB"
        }
        
        output "alb_dns_name" {
          value = module.alb.alb_dns_name
          description = "The DNS name of the ALB"
        }
        
        output "alb_zone_id" {
          value = module.alb.alb_zone_id
          description = "The zone ID of the ALB"
        }
        
        output "security_group_id" {
          value = module.alb.security_group_id
          description = "The ID of the security group attached to the ALB"
        }
        
        output "target_group_arn" {
          value = module.alb.target_group_arn
          description = "The ARN of the default target group"
        }
        EOF
        
        elif [[ "${{ github.event.inputs.resource_type }}" == "security_group" ]]; then
          # Parse the ingress rules from JSON
          cat > terraform-config/main.tf << EOF
        provider "aws" {
          region = var.region
        }
        
        locals {
          ingress_rules = jsondecode(var.ingress_rules)
        }
        
        module "security_group" {
          source = "../terraform/modules/security_group"
          
          name          = var.name
          environment   = var.environment
          region        = var.region
          vpc_id        = var.vpc_id
          description   = var.sg_description
          ingress_rules = local.ingress_rules
          deployment_id = var.deployment_id
        }
        EOF
          
          # Create outputs.tf for Security Group
          cat > terraform-config/outputs.tf << EOF
        output "security_group_id" {
          value = module.security_group.security_group_id
          description = "The ID of the security group"
        }
        
        output "security_group_arn" {
          value = module.security_group.security_group_arn
          description = "The ARN of the security group"
        }
        
        output "security_group_name" {
          value = module.security_group.security_group_name
          description = "The name of the security group"
        }
        EOF
        
        else
          echo "Unsupported resource type: ${{ github.event.inputs.resource_type }}"
          exit 1
        fi
        
        # Copy modules directory to workspace
        mkdir -p terraform-config/modules
        cp -r terraform/modules/* terraform-config/modules/
    
    - name: Terraform Init
      working-directory: terraform-config
      run: terraform init
    
    - name: Terraform Plan
      working-directory: terraform-config
      run: terraform plan -var="deployment_id=${{ steps.deployment_id.outputs.id }}" -out=tfplan
      
    - name: Terraform Apply
      working-directory: terraform-config
      run: terraform apply -auto-approve tfplan
    
    - name: Capture Terraform Outputs
      working-directory: terraform-config
      id: terraform_output
      run: |
        OUTPUTS=$(terraform output -json)
        echo "outputs=$OUTPUTS" >> $GITHUB_OUTPUT
    
    - name: Post Success Results to Application
      if: success() && env.APP_WEBHOOK_URL != ''
      run: |
          # Generate detailed logs
          LOGS_JSON=$(cat <<-EOF
          [
            "Starting Terraform deployment for ${{ github.event.inputs.resource_type }}",
            "Name: ${{ github.event.inputs.name }}",
            "Environment: ${{ github.event.inputs.environment }}",
            "Region: ${{ github.event.inputs.region }}",
            "Terraform initialization completed successfully",
            "Terraform plan completed successfully",
            "Terraform apply completed successfully",
            "Resource created successfully"
          ]
          EOF
          )
          
          # Send webhook with detailed information
          curl -X POST -H "Content-Type: application/json" -d '{
            "secret": "${{ secrets.WEBHOOK_SECRET }}",
            "deployment_id": "${{ steps.deployment_id.outputs.id }}",
            "status": "completed",
            "resource_type": "${{ github.event.inputs.resource_type }}",
            "name": "${{ github.event.inputs.name }}",
            "environment": "${{ github.event.inputs.environment }}",
            "region": "${{ github.event.inputs.region }}",
            "outputs": ${{ steps.terraform_output.outputs.outputs }},
            "requested_by": "${{ github.actor }}",
            "completed_at": "'$(date -u +"%Y-%m-%dT%H:%M:%SZ")'",
            "logs": '"$LOGS_JSON"'
          }' ${{ env.APP_WEBHOOK_URL }}
      
    - name: Post Failure Results to Application
      if: failure() && env.APP_WEBHOOK_URL != ''
      run: |
          # Determine which step failed
          FAILED_STEP="Unknown"
          ERROR_MESSAGE="Deployment failed in GitHub Actions workflow"
          
          if [ -f "terraform-config/terraform.log" ]; then
            ERROR_MESSAGE=$(tail -n 20 terraform-config/terraform.log)
          elif [ -f "terraform-config/error.log" ]; then
            ERROR_MESSAGE=$(cat terraform-config/error.log)
          fi
          
          # Generate detailed error logs
          LOGS_JSON=$(cat <<-EOF
          [
            "Deployment of ${{ github.event.inputs.resource_type }} failed",
            "Name: ${{ github.event.inputs.name }}",
            "Environment: ${{ github.event.inputs.environment }}",
            "Region: ${{ github.event.inputs.region }}",
            "Error details: ${ERROR_MESSAGE}"
          ]
          EOF
          )
          
          # Send webhook with detailed error information
          curl -X POST -H "Content-Type: application/json" -d '{
            "secret": "${{ secrets.WEBHOOK_SECRET }}",
            "deployment_id": "${{ steps.deployment_id.outputs.id }}",
            "status": "failed",
            "resource_type": "${{ github.event.inputs.resource_type }}",
            "name": "${{ github.event.inputs.name }}",
            "environment": "${{ github.event.inputs.environment }}",
            "region": "${{ github.event.inputs.region }}",
            "outputs": {},
            "error_message": "'"$ERROR_MESSAGE"'",
            "requested_by": "${{ github.actor }}",
            "completed_at": "'$(date -u +"%Y-%m-%dT%H:%M:%SZ")'",
            "logs": '"$LOGS_JSON"'
          }' ${{ env.APP_WEBHOOK_URL }}